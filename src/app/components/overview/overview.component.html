<div class="analytics">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8">
        <div>
            <h1 class="page-title mb-0">Analytics</h1>
            <p class="text-gray-500 text-sm mt-1">Track your trading performance over time</p>
        </div>
        <button (click)="showInstructions = !showInstructions" 
            class="flex items-center gap-2 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-gray-300 text-sm transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            {{showInstructions ? 'Hide' : 'Show'}} Instructions
        </button>
    </div>

    <!-- Instructions Panel -->
    <div class="trading-card mb-6" *ngIf="showInstructions">
        <div class="flex items-start gap-4">
            <div class="w-10 h-10 rounded-full bg-purple-500/20 flex items-center justify-center flex-shrink-0">
                <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
            </div>
            <div class="flex-1">
                <h3 class="text-lg font-semibold text-white mb-3">What is Analytics?</h3>
                <p class="text-gray-300 mb-4 leading-relaxed">
                    Analytics provides comprehensive insights into your trading performance across different time periods. 
                    It visualizes your profit/loss patterns, identifies your best and worst trading days, 
                    and helps you understand your trading behavior to make data-driven decisions.
                </p>

                <h4 class="text-md font-semibold text-white mb-2 mt-4">Key Features:</h4>
                <ul class="space-y-2 text-gray-300 mb-4">
                    <li><strong class="text-white">Monthly P&L Grid:</strong> Visual calendar view showing daily profit/loss with color coding - darker green for higher profits, darker red for higher losses.</li>
                    <li><strong class="text-white">Streak Analysis:</strong> Track your longest winning and losing streaks to understand your trading patterns.</li>
                    <li><strong class="text-white">Success Ratio:</strong> Percentage of profitable trading days, helping you gauge consistency.</li>
                    <li><strong class="text-white">Best/Worst Days:</strong> Identify which days of the week you perform best or worst.</li>
                    <li><strong class="text-white">Funds Overview:</strong> Track total funds added, withdrawn, and net funds over time.</li>
                    <li><strong class="text-white">Average P&L:</strong> See your average profit per winning trade and average loss per losing trade.</li>
                    <li><strong class="text-white">Month Comparison:</strong> Compare current month's performance with previous month.</li>
                </ul>

                <h4 class="text-md font-semibold text-white mb-2 mt-4">How to Use:</h4>
                <ol class="list-decimal list-inside space-y-2 text-gray-300 mb-4">
                    <li><strong class="text-white">View Monthly Grid:</strong> Each month shows a calendar grid with color-coded boxes representing daily P&L.</li>
                    <li><strong class="text-white">Click Month Name:</strong> Click on any month name to see detailed analysis for that month.</li>
                    <li><strong class="text-white">Hover/Click Boxes:</strong> Hover over or click colored boxes in the grid to see specific trade details.</li>
                    <li><strong class="text-white">Analyze Patterns:</strong> Use the day analysis to identify which days of the week you trade best.</li>
                    <li><strong class="text-white">Track Progress:</strong> Monitor your success ratio, streaks, and average P&L to improve your strategy.</li>
                </ol>

                <h4 class="text-md font-semibold text-white mb-2 mt-4">Understanding Color Coding:</h4>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <p class="text-xs text-gray-400 mb-2">Profit Colors (Green):</p>
                        <div class="space-y-1">
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-emerald-300 rounded"></div>
                                <span class="text-xs text-gray-300">₹0 - ₹500</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-emerald-400 rounded"></div>
                                <span class="text-xs text-gray-300">₹500 - ₹1,000</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-emerald-500 rounded"></div>
                                <span class="text-xs text-gray-300">₹1,000 - ₹2,000</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-emerald-600 rounded"></div>
                                <span class="text-xs text-gray-300">₹2,000+</span>
                            </div>
                        </div>
                    </div>
                    <div>
                        <p class="text-xs text-gray-400 mb-2">Loss Colors (Red):</p>
                        <div class="space-y-1">
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-red-300 rounded"></div>
                                <span class="text-xs text-gray-300">₹0 - ₹500</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-red-400 rounded"></div>
                                <span class="text-xs text-gray-300">₹500 - ₹1,000</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-red-500 rounded"></div>
                                <span class="text-xs text-gray-300">₹1,000 - ₹2,000</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-red-600 rounded"></div>
                                <span class="text-xs text-gray-300">₹2,000+</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="info-box info-box-blue mt-4">
                    <p class="text-sm"><strong>Tip:</strong> Use the day analysis insights to optimize your trading schedule. If you perform better on certain days, consider adjusting your trading strategy accordingly.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Info Banner -->
    <div class="info-box info-box-blue mb-8 flex items-center gap-3">
        <svg class="w-5 h-5 text-blue-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <span>Click on month names to view detailed monthly analysis.</span>
    </div>

    <!-- Monthly PnL Grid -->
    <div class="flex gap-12 flex-wrap">
        <ng-container *ngFor="let month of monthSortedData">
            <div class="trading-card">
                <h2 class="text-xl mb-4 font-semibold month-name cursor-pointer hover:text-blue-400 transition-colors" 
                    (click)="getMonthAnalysisData(month)">
                    {{getMonthName(month.key)}}
                </h2>
                <div class="pnl-grid">
                    <ng-container *ngFor="let trade of getData(month.value); let i = index">
                        <div class="pnl-grid-box" [ngClass]="i === 0 && getDayOfWeek(trade.date)"
                            *ngIf="!trade?.noTradingDay"
                            [class.bg-emerald-300]="trade.isProfitable && trade.profit < 500 && trade.profit !== 0"
                            [class.bg-emerald-400]="trade.isProfitable && trade.profit >= 500 && trade.profit !== 0"
                            [class.bg-emerald-500]="trade.isProfitable && trade.profit >= 1000 && trade.profit !== 0"
                            [class.bg-emerald-600]="trade.isProfitable && trade.profit >= 2000 && trade.profit !== 0"
                            
                            [class.bg-red-300]="!trade.isProfitable && trade.lose < 500 && trade.lose !== 0"
                            [class.bg-red-400]="!trade.isProfitable && trade.lose >= 500 && trade.lose !== 0"
                            [class.bg-red-500]="!trade.isProfitable && trade.lose >= 1000 && trade.lose !== 0"
                            [class.bg-red-600]="!trade.isProfitable && trade.lose >= 2000 && trade.lose !== 0"

                            [pTooltip]="tooltipContent" tooltipStyleClass="custom-tooltip"
                            (click)="tradeDetail(trade)"></div>

                        <div class="pnl-grid-box bg-slate-700" [ngClass]="i === 0 && getDayOfWeek(trade.date)" *ngIf="trade?.noTradingDay"></div>
            
                        <ng-template #tooltipContent>
                            <div class="flex align-items-center p-2">
                                <span>
                                    <b [class.text-emerald-400]="trade.profit > 0" [class.text-red-400]="trade.lose">
                                        {{getDayOfWeek(trade.date)}} <br> {{trade.date}}: {{trade.isProfitable ? '+' + trade.profit : '-' + trade.lose}}</b>
                                </span>
                            </div>
                        </ng-template>
                    </ng-container>
                </div>
            </div>
        </ng-container>
    </div>

    <!-- Monthly Analysis Section -->
    <ng-container *ngIf="selectedMonthData">
        <!-- Streaks Section -->
        <div class="flex streaks flex-wrap gap-4 mt-8">
            <div class="streaks__item flex-1 min-w-[200px]">
                <p class="text-xs text-gray-500 uppercase tracking-wider mb-2">Longest Win Streak</p>
                <p class="text-3xl font-bold text-emerald-400">{{selectedMonthData.maxWinStreak}}</p>
            </div>

            <div class="streaks__item flex-1 min-w-[200px]">
                <p class="text-xs text-gray-500 uppercase tracking-wider mb-2">Longest Losing Streak</p>
                <p class="text-3xl font-bold text-red-400">{{selectedMonthData.maxLoseStreak}}</p>
            </div>

            <div class="streaks__item flex-1 min-w-[280px]">
                <div class="flex gap-4 items-center">
                    <p-knob [strokeWidth]="5" [valueTemplate]="selectedMonthData.totalProfitableDays + '/' + selectedMonthData.totalDays" [(ngModel)]="selectedMonthData.totalProfitableDays" [disabled]="true" [max]="selectedMonthData.totalDays"></p-knob>
                    <div>
                        <p class="text-xs text-gray-500 uppercase tracking-wider mb-2">Success Ratio</p>
                        <p class="text-3xl font-bold text-blue-400">{{((selectedMonthData.totalProfitableDays / selectedMonthData.totalDays) * 100).toFixed(2)}}%</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Best/Worst Days -->
        <div class="flex streaks flex-wrap gap-4 mt-4">
            <div class="streaks__item flex-1 min-w-[200px]">
                <p class="text-xs text-gray-500 uppercase tracking-wider mb-1">Most Profitable Day</p>
                <p class="text-gray-400 text-sm mb-2">{{selectedMonthData.maxProfitDay}}</p>
                <p class="text-2xl font-bold text-emerald-400">+₹{{selectedMonthData.maxProfitAmount | number}}</p>
            </div>

            <div class="streaks__item flex-1 min-w-[200px]">
                <p class="text-xs text-gray-500 uppercase tracking-wider mb-1">Most Losing Day</p>
                <p class="text-gray-400 text-sm mb-2">{{selectedMonthData.maxLoseDay}}</p>
                <p class="text-2xl font-bold text-red-400">-₹{{selectedMonthData.maxLoseAmount | number}}</p>
            </div>
        </div>
        
        <!-- Day Analysis -->
        <ng-container *ngIf="dayData">
            <div class="mt-6 space-y-3">
                <div class="info-box info-box-green flex items-center gap-3">
                    <svg class="w-5 h-5 text-emerald-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>On <span class="font-bold text-emerald-300">{{dayData.goodDays}}</span>, you perform best. Trade with confidence!</span>
                </div>

                <div class="info-box info-box-red flex items-center gap-3">
                    <svg class="w-5 h-5 text-red-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    <span>On <span class="font-bold text-red-300">{{dayData.badDays}}</span>, consider reducing position size or avoiding trades.</span>
                </div>
            </div>
        </ng-container>

        <!-- Funds Overview -->
        <div class="flex streaks flex-wrap gap-4 mt-4">
            <div class="streaks__item flex-1 min-w-[200px]">
                <p class="text-xs text-gray-500 uppercase tracking-wider mb-2">Total Added Funds</p>
                <p class="text-2xl font-bold text-red-400">₹{{fundData.totalAddedFundTotal | number}}</p>
            </div>

            <div class="streaks__item flex-1 min-w-[200px]">
                <p class="text-xs text-gray-500 uppercase tracking-wider mb-2">Total Withdrawals</p>
                <p class="text-2xl font-bold text-emerald-400">₹{{fundData.totalWithdrawalFundTotal | number}}</p>
            </div>

            <div class="streaks__item flex-1 min-w-[200px]">
                <p class="text-xs text-gray-500 uppercase tracking-wider mb-2">Net Funds</p>
                <p class="text-2xl font-bold" 
                   [class.text-emerald-400]="fundData.totalWithdrawalFundTotal - fundData.totalAddedFundTotal > 0"
                   [class.text-red-400]="fundData.totalWithdrawalFundTotal - fundData.totalAddedFundTotal < 0"
                   [class.text-gray-400]="fundData.totalWithdrawalFundTotal - fundData.totalAddedFundTotal === 0">
                    ₹{{fundData.totalWithdrawalFundTotal - fundData.totalAddedFundTotal | number}}
                </p>
            </div>
        </div>

        <!-- Average P&L -->
        <div class="flex streaks flex-wrap gap-4 mt-4">
            <div class="streaks__item flex-1 min-w-[250px]">
                <p class="text-xs text-gray-500 uppercase tracking-wider mb-2">Avg Profit per Winning Trade</p>
                <p class="text-2xl font-bold text-emerald-400">+₹{{selectedMonthData.averageProfit.toFixed(2) ?? '-'}}</p>
            </div>

            <div class="streaks__item flex-1 min-w-[250px]">
                <p class="text-xs text-gray-500 uppercase tracking-wider mb-2">Avg Loss per Losing Trade</p>
                <p class="text-2xl font-bold text-red-400">-₹{{selectedMonthData.averageLose.toFixed(2) ?? '-'}}</p>
            </div>
        </div>

        <!-- Total P&L Summary -->
        <div class="flex streaks flex-wrap gap-4 mt-4">
            <div class="streaks__item flex-1 min-w-[150px]">
                <p class="text-xs text-gray-500 uppercase tracking-wider mb-2">Total Profit</p>
                <p class="text-2xl font-bold text-emerald-400">+₹{{selectedMonthData.totalProfit | number}}</p>
            </div>

            <div class="streaks__item flex-1 min-w-[150px]">
                <p class="text-xs text-gray-500 uppercase tracking-wider mb-2">Total Loss</p>
                <p class="text-2xl font-bold text-red-400">-₹{{selectedMonthData.totalLose | number}}</p>
            </div>

            <div class="streaks__item flex-1 min-w-[150px]">
                <p class="text-xs text-gray-500 uppercase tracking-wider mb-2">Total Brokerage</p>
                <p class="text-2xl font-bold text-gray-400">₹{{selectedMonthData.totalBrokerage | number}}</p>
            </div>

            <div class="streaks__item flex-1 min-w-[150px]">
                <p class="text-xs text-gray-500 uppercase tracking-wider mb-2">Net Month P&L</p>
                <p class="text-2xl font-bold"
                   [class.text-emerald-400]="selectedMonthData.totalProfit - selectedMonthData.totalLose - selectedMonthData.totalBrokerage > 0"
                   [class.text-red-400]="selectedMonthData.totalProfit - selectedMonthData.totalLose - selectedMonthData.totalBrokerage < 0">
                    <span>{{selectedMonthData.totalProfit - selectedMonthData.totalLose - selectedMonthData.totalBrokerage > 0 ? '+' : ''}}₹</span>{{selectedMonthData.totalProfit - selectedMonthData.totalLose - selectedMonthData.totalBrokerage | number}}
                </p>
            </div>
        </div>

        <!-- Month Comparison -->
        <div *ngIf="previosMonthData" class="info-box info-box-yellow mt-6 flex items-center gap-3" [innerHTML]="getMonthStatus()">
        </div>
    </ng-container>

    <!-- Selected Trade Detail -->
    <ng-container *ngIf="selectedTrade">
        <div class="trading-card mt-8 overflow-hidden">
            <h3 class="text-lg font-semibold text-white mb-4">Trade Details</h3>
            <div class="overflow-x-auto">
                <table class="trading-table">
                    <thead>
                        <tr>
                            <th scope="col">Date</th>
                            <th scope="col">Total Trades</th>
                            <th scope="col">Market</th>
                            <th scope="col">Investment</th>
                            <th scope="col">P&L</th>
                            <th scope="col">Brokerage</th>
                            <th scope="col">ROI</th>
                            <th scope="col">Net</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th scope="row" class="font-medium text-gray-100 whitespace-nowrap">
                                {{selectedTrade.date}}
                            </th>
                            <td class="text-gray-300">{{selectedTrade.totalTrades}}</td>
                            <td><span class="badge badge-info">{{selectedTrade.market}}</span></td>
                            <td class="text-gray-300">₹{{selectedTrade.investment | number}}</td>
                            <td>
                                <span class="profit" *ngIf="selectedTrade.isProfitable">+₹{{selectedTrade.profit | number}}</span>
                                <span class="lose" *ngIf="!selectedTrade.isProfitable">-₹{{selectedTrade.lose | number}}</span>
                            </td>
                            <td class="text-gray-400">₹{{selectedTrade.brokerage}}</td>
                            <td>
                                <span class="profit" *ngIf="selectedTrade.isProfitable">+{{((selectedTrade.profit / selectedTrade.investment) * 100).toFixed(2)}}%</span>
                                <span class="lose" *ngIf="!selectedTrade.isProfitable">-{{((selectedTrade.lose / selectedTrade.investment) * 100).toFixed(2)}}%</span>
                            </td>
                            <td>
                                <span class="profit font-semibold" *ngIf="selectedTrade.isProfitable">₹{{(+selectedTrade.investment + +selectedTrade.profit - +selectedTrade.brokerage) | number}}</span>
                                <span class="lose font-semibold" *ngIf="!selectedTrade.isProfitable">₹{{(+selectedTrade.investment - +selectedTrade.lose - +selectedTrade.brokerage) | number}}</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </ng-container>
</div>
