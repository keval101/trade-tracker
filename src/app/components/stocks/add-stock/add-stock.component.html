<div class="stock-form">
    <form [formGroup]="stockForm" (submit)="addTrade()">
        <div class="grid gap-5 mb-6">
            <div>
                <label for="date" class="block mb-2 text-sm font-medium text-gray-300">Date</label>
                <p-calendar formControlName="date" appendTo="body" dateFormat="dd/mm/yy" placeholder="Select Date" styleClass="w-full"></p-calendar>
            </div>

            <!-- Company Search -->
            <div class="relative">
                <label for="search" class="block mb-2 text-sm font-medium text-gray-300">
                    Search Company
                    <span class="text-xs text-gray-500 font-normal ml-1">(Optional - Auto-fills details)</span>
                </label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                    <input 
                        type="text" 
                        id="search" 
                        class="form-input !pl-10" 
                        placeholder="Type company name or symbol (e.g., Reliance, RELIANCE)"
                        [(ngModel)]="searchQuery"
                        [ngModelOptions]="{standalone: true}"
                        (ngModelChange)="onSearchChange($event)"
                        (focus)="showSearchResults = searchResults.length > 0"
                        (blur)="closeSearchResults()"
                        autocomplete="off"/>
                    <div *ngIf="isSearching" class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                        <svg class="animate-spin h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                </div>
                
                <!-- Search Results Dropdown -->
                <div *ngIf="showSearchResults && searchResults.length > 0" 
                     class="absolute z-50 w-full mt-1 bg-slate-800 border border-slate-700 rounded-lg shadow-xl max-h-60 overflow-y-auto">
                    <div *ngFor="let company of searchResults; trackBy: trackBySearchResult" 
                         class="px-4 py-3 hover:bg-slate-700 cursor-pointer transition-colors border-b border-slate-700/50 last:border-b-0"
                         (click)="selectCompany(company)">
                        <div class="flex items-center gap-3">
                            <div class="flex-1">
                                <p class="text-sm font-medium text-white">{{company.symbol_info || company.name || company.companyName}}</p>
                                <p class="text-xs text-gray-400 mt-0.5">{{company.symbol}}</p>
                            </div>
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <!-- No Results -->
                <div *ngIf="showSearchResults && searchResults.length === 0 && !isSearching && searchQuery.length >= 2" 
                     class="absolute z-50 w-full mt-1 bg-slate-800 border border-slate-700 rounded-lg shadow-xl p-4">
                    <p class="text-sm text-gray-400 text-center">No companies found. Please enter details manually.</p>
                </div>
            </div>

            <div>
                <label for="name" class="block mb-2 text-sm font-medium text-gray-300">Stock Name</label>
                <input type="text" id="name" class="form-input" placeholder="Stock Name" required formControlName="name"/>
            </div>

            <div *ngIf="!stockForm.value.isSold">
                <label for="buyPrice" class="block mb-2 text-sm font-medium text-gray-300">Buy Price</label>
                <input formControlName="buyPrice" type="number" id="buyPrice" class="form-input" placeholder="Price per share" required (input)="setAmount()" min="0"/>
            </div>

            <div>
                <label for="logo" class="block mb-2 text-sm font-medium text-gray-300">Logo URL</label>
                <input type="text" id="logo" class="form-input" placeholder="Stock Logo URL" required formControlName="logo"/>
            </div>

            <div>
                <label for="code" class="block mb-2 text-sm font-medium text-gray-300">Symbol</label>
                <input type="text" id="code" class="form-input" placeholder="Stock Symbol" required formControlName="code"/>
            </div>

            <div>
                <label for="totalQuantity" class="block mb-2 text-sm font-medium text-gray-300">Total Quantity</label>
                <input formControlName="totalQuantity" type="number" id="totalQuantity" class="form-input" placeholder="Number of shares" required (input)="setAmount()" min="0"/>
            </div>

            <div class="flex items-center">
                <input id="sold-checkbox" type="checkbox" value="" formControlName="isSold" class="w-4 h-4 text-blue-600 bg-slate-700 border-slate-600 rounded focus:ring-blue-500 focus:ring-2">
                <label for="sold-checkbox" class="ms-2 text-sm font-medium text-gray-300">Sold</label>
            </div>

            <div *ngIf="stockForm.value.isSold">
                <label for="sellPrice" class="block mb-2 text-sm font-medium text-gray-300">Sell Price</label>
                <input formControlName="sellPrice" type="number" id="sellPrice" class="form-input" placeholder="Sell price per share" required (input)="setAmount()" min="0"/>
            </div>

            <div *ngIf="stockForm.value.isSold">
                <label for="totalSellAmount" class="block mb-2 text-sm font-medium text-gray-300">Total Sell Amount</label>
                <input formControlName="totalSellAmount" type="number" id="totalSellAmount" class="form-input bg-slate-700 cursor-not-allowed" placeholder="Total Sell Amount" required readonly min="0"/>
            </div>

            <div>
                <label for="totalBuyAmount" class="block mb-2 text-sm font-medium text-gray-300">Total Buy Amount</label>
                <input formControlName="totalBuyAmount" type="number" id="totalBuyAmount" class="form-input bg-slate-700 cursor-not-allowed" placeholder="Total Buy Amount" required readonly min="0"/>
            </div>
        </div>
        <div class="footer-btn">
            <button type="submit" 
                [ngClass]="{'bg-blue-400/50 cursor-not-allowed': stockForm.invalid, 'bg-blue-600 hover:bg-blue-700' : !stockForm.invalid }" 
                class="text-white focus:ring-4 focus:outline-none focus:ring-blue-500/30 font-medium rounded-lg text-sm w-full sm:w-auto px-5 py-2.5 text-center transition-colors">
                Submit
            </button>
        </div>
    </form>
</div>
